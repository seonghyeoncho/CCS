# 분산 시스템 만들기

망형 토폴로지를 구현하기 위해서 노드들의 위치와 접속 가능 상태를 알아야 합니다.

가장 간단한 방법은 모든 노드가 알고 있는 위치에 자신의 정보를 저장하는 것입니다.

모든 노드가 접속해 자신의 상태를 저장할 수 있는 서버 Distributor라고 하겠습니다.

안정적으로 분산처리하기 위해서는 세가지 상태가 고려되어야 합니다.

1. Distributor가 실행되지 않았을 때도 각 노드들을 Distributor에 주기적으로 접속을 시도해야한다. 
2. 노드가 Distributor에 접속하거나 접속이 종료되었을 때 Distributor는 이를 인지하고 다른 노드에 이 사실을 알려야한다.
3. Distributor가 종료되어도 각 노드는 알고 있는 정보를 이용해 각 노드 간 접속 상태를 유지해야한다.

Distributor 입장에서 각 노드는 클라이언트지만, 요청을 처리하는 서버가 되기도 합니다.

예를 들어 Distributor의 노드 중 하나인 웹 서버 노드는 사용자의 요청을 받는 서버의 역할을 하면서 Distributor의 클라이언트기도 합니다.

공통으로 사용할 Client와 Server 클래스를 만들고 상속받아 사용하도록 하겠습니다.

## Client
클라이언트는 다음 기능을 수행합니다.
- 접속
- 데이터 수신
- 데이터 발송

[Client](/NodeJS/EcommerceMicro/Distributor/client.js)

## Server
서버 역할을 하는 클래스입니다. 

클라이언트 클래스를 이용하여 Distributor에 주기적으로 접속하는 기능을 추가합니다.

[Server](/NodeJS/EcommerceMicro/Distributor/server.js)

## Distributor
모든 노드가 접속해 자신의 상태를 저장할 수 있는 서버입니다.

[Distributor](/NodeJS/EcommerceMicro/Distributor/distributor.js)

## HTTP Gateway
클라이언트가 각 모든 노드에서의 모든 API를 호출하는건 너무 비효율적인 일입니다. 

따라서 Gateway를 제공하여 통일된 인터페이스로 모든 API를 호출할 수 있도록 합니다.

게이트웨이는 다음 역할을 수행합니다.

- 요청 객체 저장, 서비스 호춣
- 응답 후 요청 객체 삭제

하나의 서비스의 인스턴스가 여러개 있을 수 있습니다.


그래서 라운드 로빈 방식으로 부하를 줄일 수 있습니다.

[Gateway](/NodeJS/EcommerceMicro/gate.js)


# 장애 처리
## Failover
예비 시스템으로 자동 전환해서 서비스가 중단되지 않도록 하는 방법입니다.

## Fault Tolerant
시스템에 문제가 발생하면 전체 시스템을 다운하는 것이 아니라 문제가 발생하지 않은 부분은 정상적으로 수행하는 방법입니다.

MSA는 기본적으로 분산 아키텍처이기 때문에 MS를 충분히 배치했다면 Failover 기능을 수행한다고 할 수 있습니다.

또 특정 MS가 다운되어도 다른 MS가 정상적으로 작동된다면 Fault Tolerant 기능을 수행한다고 할 수 있습니다.

## Cluster
Node.js에는 Cluster라는 모듈을 기본으로 제공합니다. 

Cluster 모듈은 우리가 실행한 프로세스에서 원하는 만큼 자식 프로세스를 생성합니다.

문제가 발생해도 자식 프로세스 하나에서만 발생하기 때문에 다른 자식 프로세스는 정상적으로 서비스할 수 있습니다.

하지만 자원을 생각하여 자식 프로세스의 개수를 제한해야합니다.

# 공유 자원
MS는 프로세스를 독립적으로 실행하기 때문에 공유 자원을 고려해야 합니다.

공유 자원을 처리하는 가장 쉬운 방법은 데이터베이스처럼 데이터를 저장하는 저장소를 공통으로 사용하는 것입니다.

# 로그
로그를 관리하는 MS를 만들고, 모든 MS는 로그 관리 MS에 로그를 전달하도록 합니다. 


